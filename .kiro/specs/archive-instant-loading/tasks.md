# Implementation Plan

- [x] 1. 创建索引缓存核心模块
  - [x] 1.1 创建 `src-tauri/src/core/archive_index_cache.rs` 文件
    - 定义 `ArchiveIndex` 和 `IndexEntry` 结构体
    - 实现 Serialize/Deserialize trait
    - _Requirements: 1.5_
  - [x] 1.2 编写属性测试：索引序列化往返
    - **Property 1: Index Cache Round-Trip**
    - **Validates: Requirements 8.5**
  - [x] 1.3 实现 `IndexCache` 结构体
    - 实现内存 LRU 缓存
    - 实现 `get_or_create` 方法
    - 实现缓存验证逻辑（修改时间、文件大小）
    - _Requirements: 1.1, 1.2, 1.3_
  - [x] 1.4 编写属性测试：缓存验证一致性
    - **Property 2: Cache Validation Consistency**
    - **Validates: Requirements 1.3, 1.4**
  - [x] 1.5 实现持久化存储
    - 实现二进制格式序列化（Magic + Version + Data + CRC32）
    - 实现 `persist` 和 `load` 方法
    - _Requirements: 8.1, 8.2, 8.3_
  - [x] 1.6 编写属性测试：版本兼容性
    - **Property 10: Version Compatibility**
    - **Validates: Requirements 8.4**
  - [x] 1.7 实现 LRU 驱逐策略
    - 实现 `cleanup` 方法
    - 按最后访问时间驱逐
    - _Requirements: 1.6_
  - [x] 1.8 编写属性测试：LRU 驱逐顺序
    - **Property 3: LRU Eviction Order**
    - **Validates: Requirements 1.6**

- [x] 2. Checkpoint - 确保所有测试通过
  - Ensure all tests pass, ask the user if questions arise.

- [x] 3. 创建实例缓存模块
  - [x] 3.1 创建 `src-tauri/src/core/archive_instance_cache.rs` 文件
    - 定义 `InstanceCache` 结构体
    - 使用 `Weak<Mutex<ZipArchive<File>>>` 存储弱引用
    - _Requirements: 2.1_
  - [x] 3.2 实现 `get_or_create` 方法
    - 检查缓存命中
    - 创建新实例并缓存
    - _Requirements: 2.2_
  - [x] 3.3 编写属性测试：实例缓存复用
    - **Property 4: Instance Cache Reuse**
    - **Validates: Requirements 2.2**
  - [x] 3.4 实现 `cleanup` 和 `invalidate` 方法
    - 清理失效的弱引用
    - 支持手动失效指定路径
    - _Requirements: 2.3, 2.4_

- [x] 4. 创建预热系统模块
  - [x] 4.1 创建 `src-tauri/src/core/archive_preheat.rs` 文件
    - 定义 `PreheatSystem` 结构体
    - 实现预热队列
    - _Requirements: 4.1_
  - [x] 4.2 实现 `get_adjacent_archives` 方法
    - 获取同目录下的相邻压缩包
    - 按自然排序确定顺序
    - _Requirements: 4.1_
  - [x] 4.3 编写属性测试：相邻压缩包识别
    - **Property 6: Adjacent Archive Identification**
    - **Validates: Requirements 4.1**
  - [x] 4.4 实现 `trigger` 方法
    - 触发预热任务
    - 管理队列大小
    - _Requirements: 4.2, 4.5_
  - [x] 4.5 编写属性测试：预热队列限制
    - **Property 7: Preheat Queue Limit**
    - **Validates: Requirements 4.5**
  - [x] 4.6 实现后台预热任务
    - 异步加载索引到缓存
    - 支持取消
    - _Requirements: 4.3_

- [x] 5. Checkpoint - 确保所有测试通过
  - Ensure all tests pass, ask the user if questions arise.

- [x] 6. 创建命令队列模块
  - [x] 6.1 创建 `src-tauri/src/core/load_command_queue.rs` 文件
    - 定义 `LoadCommand` 和 `CommandQueue` 结构体
    - 实现取消令牌
    - _Requirements: 6.1_
  - [x] 6.2 实现 `submit` 方法
    - 取消当前命令
    - 提交新命令
    - _Requirements: 6.2_
  - [x] 6.3 编写属性测试：命令取消
    - **Property 8: Command Cancellation**
    - **Validates: Requirements 6.2**
  - [x] 6.4 实现完成通知
    - 使用 broadcast channel 通知完成
    - _Requirements: 6.5_

- [x] 7. 集成到 BookManager
  - [x] 7.1 修改 `src-tauri/src/core/book_manager.rs`
    - 添加 IndexCache、InstanceCache、PreheatSystem 依赖
    - _Requirements: 1.1, 2.1, 4.1_
  - [x] 7.2 实现 `open_book_async` 方法
    - 使用索引缓存获取文件列表
    - 并行加载首页和文件列表
    - _Requirements: 3.1, 3.2, 3.3_
  - [x] 7.3 编写属性测试：首页优先可用
    - **Property 5: First Page Availability**
    - **Validates: Requirements 3.2, 3.3**
  - [x] 7.4 集成预热系统
    - 在打开压缩包后触发预热
    - _Requirements: 4.2_
  - [x] 7.5 添加性能监控
    - 记录各阶段耗时
    - 超时警告日志
    - _Requirements: 7.1, 7.2, 7.5_
  - [x] 7.6 编写属性测试：性能指标记录
    - **Property 9: Performance Metrics Recording**
    - **Validates: Requirements 7.1, 7.2**

- [x] 8. Checkpoint - 确保所有测试通过
  - Ensure all tests pass, ask the user if questions arise.

- [x] 9. 添加 Tauri 命令
  - [x] 9.1 创建新的异步打开命令
    - 添加 `open_book_async` 命令
    - 支持取消参数
    - _Requirements: 6.1_
  - [x] 9.2 添加预热控制命令
    - 添加 `preheat_adjacent_archives` 命令
    - 添加 `cancel_preheat` 命令
    - _Requirements: 4.2, 4.5_
  - [x] 9.3 添加缓存管理命令
    - 添加 `clear_index_cache` 命令
    - 添加 `get_cache_stats` 命令
    - _Requirements: 1.6, 7.3_

- [x] 10. 前端集成
  - [x] 10.1 修改 `src/lib/api/book.ts`
    - 添加 `openBookAsync` API
    - 添加取消支持
    - _Requirements: 6.1, 6.4_
  - [x] 10.2 修改 `src/lib/stores/book.svelte.ts`
    - 使用新的异步打开 API
    - 处理取消逻辑
    - _Requirements: 6.2, 6.4_
  - [x] 10.3 添加加载状态显示
    - 显示加载进度
    - 支持 Escape 取消
    - _Requirements: 6.3, 6.4_
  - [x] 10.4 更新信息面板
    - 显示加载耗时
    - 显示缓存状态
    - _Requirements: 7.3, 7.4_

- [x] 11. Final Checkpoint - 确保所有测试通过

  - Ensure all tests pass, ask the user if questions arise.
