# Implementation Plan: Large File Refactor

## Overview

将 7 个超过 800 行的 Rust 源文件重构为模块化结构。每个文件拆分为一个同名目录，包含多个职责单一的子模块。采用渐进式重构，每完成一个文件后验证编译。

## Tasks

- [x] 1. 重构 fs_commands.rs (2096 行)
  - [ ] 1.1 创建 fs_commands 目录结构
    - 创建 `src-tauri/src/commands/fs_commands/` 目录
    - 创建 `mod.rs` 文件，包含状态结构体和模块声明
    - _Requirements: 2.1, 2.2, 4.1_
  - [ ] 1.2 提取 types.rs
    - 提取 FileInfo, SubfolderItem, DirectorySnapshotResponse, BatchDirectorySnapshotResult, StreamBatchResult 等类型
    - _Requirements: 4.2_
  - [ ] 1.3 提取 read_ops.rs
    - 提取 read_directory, get_file_info, path_exists, read_text_file, browse_directory, list_subfolders, get_images_in_directory, get_file_metadata 命令
    - _Requirements: 4.2_
  - [ ] 1.4 提取 write_ops.rs
    - 提取 create_directory, delete_path, rename_path, move_to_trash, move_to_trash_async, copy_path, move_path, write_text_file, open_with_system, show_in_file_manager 命令
    - _Requirements: 4.2_
  - [ ] 1.5 提取 cache_ops.rs
    - 提取 load_directory_snapshot, batch_load_directory_snapshots, browse_directory_page, start_directory_stream, get_next_stream_batch, cancel_directory_stream, cache_index_stats, cache_index_gc, enqueue_cache_maintenance 命令
    - _Requirements: 4.2_
  - [ ] 1.6 提取 archive_ops.rs
    - 提取 list_archive_contents, delete_archive_entry, load_image_from_archive_*, extract_image_to_temp, extract_for_clipboard, get_images_from_archive, batch_extract_archive, is_supported_archive, batch_scan_archives, preload_archive_pages 命令
    - _Requirements: 4.2_
  - [ ] 1.7 提取 index_ops.rs
    - 提取 search_files, initialize_file_index, build_file_index, get_index_stats, clear_file_index, search_in_index, get_indexed_paths, is_path_indexed, get_index_progress, get_unindexed_files 命令
    - _Requirements: 4.2_
  - [ ] 1.8 更新 mod.rs 重导出并删除原文件
    - 添加 pub use 语句重导出所有公共 API
    - 删除原 fs_commands.rs 文件
    - 更新 commands/mod.rs 中的模块声明
    - _Requirements: 3.3, 4.3_
  - [ ] 1.9 验证 fs_commands 重构
    - 运行 cargo check 确保编译通过
    - 检查所有新模块文件行数 ≤ 800
    - _Requirements: 1.1, 12.1_

- [ ] 2. 重构 thumbnail_db.rs (1976 行)
  - [ ] 2.1 创建 thumbnail_db 目录结构
    - 创建 `src-tauri/src/core/thumbnail_db/` 目录
    - 创建 `mod.rs` 文件，包含 ThumbnailDb 主结构
    - _Requirements: 2.1, 2.2, 5.1_
  - [ ] 2.2 提取 types.rs
    - 提取 CompressionStats, ThumbnailDbStats, ThumbnailDbRecord 类型
    - _Requirements: 5.2_
  - [ ] 2.3 提取 compression.rs
    - 提取 compress_blob, decompress_blob, is_compressed 函数和 LZ4_MAGIC 常量
    - _Requirements: 5.2_
  - [ ] 2.4 提取 schema.rs
    - 提取 initialize_db, auto_migrate, get_db_version, set_db_version, get_table_columns, migrate_rating_from_emm_json 函数
    - _Requirements: 5.2_
  - [ ] 2.5 提取 crud.rs
    - 提取 save_thumbnail, save_thumbnail_with_category, load_thumbnail, load_thumbnail_by_key_and_category, load_thumbnail_with_category, has_thumbnail, has_thumbnail_by_key_and_category, has_thumbnail_with_category, update_access_time 函数
    - _Requirements: 5.2_
  - [ ] 2.6 提取 batch_ops.rs
    - 提取 save_thumbnails_batch, batch_load_thumbnails, batch_check_failed 函数
    - _Requirements: 5.2_
  - [ ] 2.7 提取 emm_ops.rs
    - 提取 save_emm_json, batch_save_emm_json, get_emm_json, batch_get_emm_json, upsert_with_emm_json, load_thumbnail_with_emm_json, get_all_thumbnail_keys, get_folder_keys, get_keys_without_emm_json, get_thumbnail_keys_by_prefix 函数
    - _Requirements: 5.2_
  - [ ] 2.8 提取 rating_ops.rs
    - 提取 update_rating_data, get_rating_data, batch_get_rating_data, get_rating_data_by_prefix, save_emm_with_rating_data, batch_save_emm_with_rating_data 函数
    - _Requirements: 5.2_
  - [ ] 2.9 提取 maintenance.rs
    - 提取 delete_old_thumbnails, vacuum, get_database_size, save_failed_thumbnail, get_failed_thumbnail, remove_failed_thumbnail, cleanup_old_failures, normalize_all_keys, update_manual_tags, get_manual_tags, batch_get_manual_tags 函数
    - _Requirements: 5.2_
  - [ ] 2.10 更新 mod.rs 重导出并删除原文件
    - 添加 pub use 语句重导出所有公共 API
    - 删除原 thumbnail_db.rs 文件
    - 更新 core/mod.rs 中的模块声明
    - _Requirements: 3.3, 5.3_
  - [ ] 2.11 验证 thumbnail_db 重构
    - 运行 cargo check 确保编译通过
    - 检查所有新模块文件行数 ≤ 800
    - _Requirements: 1.1, 12.1_

- [ ] 3. 重构 benchmark_commands.rs (1610 行)
  - [ ] 3.1 创建 benchmark_commands 目录结构
    - 创建 `src-tauri/src/commands/benchmark_commands/` 目录
    - 创建 `mod.rs` 文件
    - _Requirements: 2.1, 2.2, 6.1_
  - [ ] 3.2 提取 types.rs
    - 提取 BenchmarkResult, BenchmarkReport, ArchiveScanResult, DetailedBenchmarkResult, LoadModeTestResult, BitmapLoadResult, TranscodeBenchmarkReport 等类型
    - _Requirements: 6.2_
  - [ ] 3.3 提取 image_benchmark.rs
    - 提取 run_image_benchmark, run_batch_benchmark, test_load_modes, load_image_as_bitmap, load_image_as_bitmap_scaled 命令
    - _Requirements: 6.2_
  - [ ] 3.4 提取 thumbnail_benchmark.rs
    - 提取 generate_thumbnail_benchmark, generate_thumbnail_with_image_crate, generate_thumbnail_with_wic, generate_thumbnail_with_wic_fast, generate_thumbnail_with_format 函数
    - _Requirements: 6.2_
  - [ ] 3.5 提取 archive_benchmark.rs
    - 提取 scan_archive_folder, run_detailed_benchmark, run_archive_folder_benchmark, run_archive_thumbnail_benchmark 命令
    - _Requirements: 6.2_
  - [ ] 3.6 提取 wic_benchmark.rs
    - 提取 load_image_wic_lz4, load_image_wic_lz4_cached, clear_wic_lz4_cache, WIC_LZ4_CACHE 相关代码
    - _Requirements: 6.2_
  - [ ] 3.7 提取 realworld_benchmark.rs
    - 提取 run_realworld_benchmark, run_transcode_benchmark 命令
    - _Requirements: 6.2_
  - [ ] 3.8 更新 mod.rs 重导出并删除原文件
    - 添加 pub use 语句重导出所有公共 API
    - 删除原 benchmark_commands.rs 文件
    - 更新 commands/mod.rs 中的模块声明
    - _Requirements: 3.3, 6.3_
  - [ ] 3.9 验证 benchmark_commands 重构
    - 运行 cargo check 确保编译通过
    - 检查所有新模块文件行数 ≤ 800
    - _Requirements: 1.1, 12.1_

- [ ] 4. 重构 archive.rs (1457 行)
  - [ ] 4.1 创建 archive 目录结构
    - 创建 `src-tauri/src/core/archive/` 目录
    - 创建 `mod.rs` 文件，包含 ArchiveManager 主结构
    - _Requirements: 2.1, 2.2, 7.1_
  - [ ] 4.2 提取 types.rs
    - 提取 ArchiveEntry, ArchiveMetadata, CachedImageEntry 类型
    - _Requirements: 7.2_
  - [ ] 4.3 提取 format.rs
    - 提取 ArchiveFormat 枚举、ARCHIVE_IMAGE_EXTENSIONS, ZIP_EXTENSIONS, RAR_EXTENSIONS, SEVENZ_EXTENSIONS 常量
    - _Requirements: 7.2_
  - [ ] 4.4 提取 zip_handler.rs
    - 提取 list_zip_contents, extract_file_from_zip, delete_entry_from_zip, get_cached_archive 函数
    - _Requirements: 7.2_
  - [ ] 4.5 提取 rar_handler.rs
    - 提取 list_rar_contents, extract_file_from_rar, get_rar_entry_index, build_rar_index 函数
    - _Requirements: 7.2_
  - [ ] 4.6 提取 sevenz_handler.rs
    - 提取 list_7z_contents, extract_file_from_7z, get_7z_entry_index, build_7z_index 函数
    - _Requirements: 7.2_
  - [ ] 4.7 提取 image_ops.rs
    - 提取 load_image_from_archive_binary, load_jxl_binary_from_zip, load_jxl_from_zip, get_images_from_archive, find_first_image_entry, scan_archive_images_fast, get_first_image_blob_or_scan, get_first_image_blob, get_first_image_bytes 函数
    - _Requirements: 7.2_
  - [ ] 4.8 提取 cache.rs
    - 提取 clear_cache, limit_cache_size, preload_all_images, extract_file_stream 函数
    - _Requirements: 7.2_
  - [ ] 4.9 更新 mod.rs 重导出并删除原文件
    - 添加 pub use 语句重导出所有公共 API
    - 删除原 archive.rs 文件
    - 更新 core/mod.rs 中的模块声明
    - _Requirements: 3.3, 7.3_
  - [ ] 4.10 验证 archive 重构
    - 运行 cargo check 确保编译通过
    - 检查所有新模块文件行数 ≤ 800
    - _Requirements: 1.1, 12.1_

- [ ] 5. 重构 thumbnail_commands.rs (1295 行)
  - [ ] 5.1 创建 thumbnail_commands 目录结构
    - 创建 `src-tauri/src/commands/thumbnail_commands/` 目录
    - 创建 `mod.rs` 文件，包含 ThumbnailState 和 init_thumbnail_manager
    - _Requirements: 2.1, 2.2, 8.1_
  - [ ] 5.2 提取 types.rs
    - 提取 ThumbnailIndexRequest, ThumbnailIndexResult, FolderScanResult, FolderMatchKind 类型
    - _Requirements: 8.2_
  - [ ] 5.3 提取 generation.rs
    - 提取 generate_file_thumbnail_new, generate_archive_thumbnail_new, generate_video_thumbnail_new, save_folder_thumbnail 命令
    - _Requirements: 8.2_
  - [ ] 5.4 提取 retrieval.rs
    - 提取 has_thumbnail_by_key_category, has_thumbnail, load_thumbnail_from_db, load_thumbnail_with_emm_json, get_thumbnail_blob_data 命令
    - _Requirements: 8.2_
  - [ ] 5.5 提取 batch_ops.rs
    - 提取 batch_preload_thumbnails, batch_load_thumbnails_from_db, preload_thumbnail_index, scan_folder_thumbnails 命令
    - _Requirements: 8.2_
  - [ ] 5.6 提取 emm_commands.rs
    - 提取 save_emm_json, batch_save_emm_json, get_emm_json, batch_get_emm_json, get_all_thumbnail_keys, get_thumbnail_keys_by_prefix, upsert_with_emm_json, get_keys_without_emm_json 命令
    - _Requirements: 8.2_
  - [ ] 5.7 提取 rating_commands.rs
    - 提取 update_rating_data, get_rating_data, batch_get_rating_data, get_rating_data_by_prefix, batch_save_emm_with_rating_data, calculate_folder_ratings 命令
    - _Requirements: 8.2_
  - [ ] 5.8 提取 maintenance_commands.rs
    - 提取 save_failed_thumbnail, get_failed_thumbnail, remove_failed_thumbnail, batch_check_failed_thumbnails, cleanup_old_failures, migrate_thumbnail_db, normalize_thumbnail_keys, cleanup_invalid_thumbnails, get_thumbnail_maintenance_stats, search_by_tags, count_matching_collect_tags, batch_count_matching_collect_tags, save_ai_translation, load_ai_translation, batch_load_ai_translations, get_ai_translation_count, update_manual_tags, get_manual_tags, batch_get_manual_tags 命令
    - _Requirements: 8.2_
  - [ ] 5.9 更新 mod.rs 重导出并删除原文件
    - 添加 pub use 语句重导出所有公共 API
    - 删除原 thumbnail_commands.rs 文件
    - 更新 commands/mod.rs 中的模块声明
    - _Requirements: 3.3, 8.3_
  - [ ] 5.10 验证 thumbnail_commands 重构
    - 运行 cargo check 确保编译通过
    - 检查所有新模块文件行数 ≤ 800
    - _Requirements: 1.1, 12.1_

- [ ] 6. 重构 thumbnail_service_v3.rs (1353 行)
  - [ ] 6.1 创建 thumbnail_service_v3 目录结构
    - 创建 `src-tauri/src/core/thumbnail_service_v3/` 目录
    - 创建 `mod.rs` 文件，包含 ThumbnailServiceV3 主结构
    - _Requirements: 2.1, 2.2, 9.1_
  - [ ] 6.2 提取 config.rs
    - 提取 ThumbnailServiceConfig 结构体及其 Default 实现
    - _Requirements: 9.2_
  - [ ] 6.3 提取 types.rs
    - 提取 ThumbnailFileType, GenerateTask, ThumbnailReadyPayload, ThumbnailBatchReadyPayload, CacheStats 类型
    - _Requirements: 9.2_
  - [ ] 6.4 提取 worker.rs
    - 提取工作线程启动逻辑、任务处理循环、保存队列刷新线程
    - _Requirements: 9.2_
  - [ ] 6.5 提取 queue.rs
    - 提取任务队列管理、优先级排序逻辑
    - _Requirements: 9.2_
  - [ ] 6.6 提取 cache.rs
    - 提取 LRU 内存缓存管理、get_from_memory_cache, has_in_memory_cache, two_phase_cache_cleanup, check_memory_pressure 函数
    - _Requirements: 9.2_
  - [ ] 6.7 提取 db_index.rs
    - 提取 load_indices_from_db, 数据库索引管理相关代码
    - _Requirements: 9.2_
  - [ ] 6.8 提取 generators.rs
    - 提取 generate_folder_thumbnail_static, generate_archive_thumbnail_static, generate_video_thumbnail_static, generate_file_thumbnail_static 静态方法
    - _Requirements: 9.2_
  - [ ] 6.9 更新 mod.rs 重导出并删除原文件
    - 添加 pub use 语句重导出所有公共 API
    - 删除原 thumbnail_service_v3.rs 文件
    - 更新 core/mod.rs 中的模块声明
    - _Requirements: 3.3, 9.3_
  - [ ] 6.10 验证 thumbnail_service_v3 重构
    - 运行 cargo check 确保编译通过
    - 检查所有新模块文件行数 ≤ 800
    - _Requirements: 1.1, 12.1_

- [ ] 7. 重构 upscale_service.rs (1249 行)
  - [ ] 7.1 创建 upscale_service 目录结构
    - 创建 `src-tauri/src/core/upscale_service/` 目录
    - 创建 `mod.rs` 文件，包含 UpscaleService 主结构
    - _Requirements: 2.1, 2.2, 10.1_
  - [ ] 7.2 提取 config.rs
    - 提取 UpscaleServiceConfig 结构体及其 Default 实现
    - _Requirements: 10.2_
  - [ ] 7.3 提取 types.rs
    - 提取 TaskPriority, TaskScore, UpscaleTask, CacheEntry 类型
    - _Requirements: 10.2_
  - [ ] 7.4 提取 events.rs
    - 提取 UpscaleStatus, UpscaleReadyPayload, UpscaleServiceStats 类型
    - _Requirements: 10.2_
  - [ ] 7.5 提取 worker.rs
    - 提取工作线程启动逻辑、任务处理循环
    - _Requirements: 10.2_
  - [ ] 7.6 提取 queue.rs
    - 提取任务队列管理、优先级排序、replan_queue_for_jump 函数
    - _Requirements: 10.2_
  - [ ] 7.7 提取 conditions.rs
    - 提取 sync_conditions, match_condition, update_condition_settings 函数
    - _Requirements: 10.2_
  - [ ] 7.8 提取 cache.rs
    - 提取 cache_key, get_cache_path, check_cache, validate_cache_file, clear_cache 函数
    - _Requirements: 10.2_
  - [ ] 7.9 更新 mod.rs 重导出并删除原文件
    - 添加 pub use 语句重导出所有公共 API
    - 删除原 upscale_service.rs 文件
    - 更新 core/mod.rs 中的模块声明
    - _Requirements: 3.3, 10.3_
  - [ ] 7.10 验证 upscale_service 重构
    - 运行 cargo check 确保编译通过
    - 检查所有新模块文件行数 ≤ 800
    - _Requirements: 1.1, 12.1_

- [ ] 8. 最终验证
  - [ ] 8.1 运行完整编译检查
    - 运行 cargo check 确保整个项目编译通过
    - _Requirements: 12.1_
  - [ ] 8.2 运行 yarn check
    - 运行 yarn check 确保前端集成正常
    - _Requirements: 12.2_
  - [ ] 8.3 验证所有文件行数
    - 检查所有新创建的 .rs 文件行数 ≤ 800
    - _Requirements: 1.1_

## Notes

- 每个大任务（1-7）完成后都有验证步骤，确保增量重构的正确性
- 重构顺序按文件大小从大到小，优先处理最大的文件
- 使用 `pub use` 保持 API 兼容，外部代码无需修改导入路径
- 如果某个模块拆分后仍超过 800 行，需要进一步细分
