# 缩略图系统功能增强 - 需求总结

## 📋 需求概述

用户提出了一个完整的缩略图系统功能增强方案，包含 4 个主要功能模块：

```
┌─────────────────────────────────────────────────────────┐
│         缩略图系统功能增强方案                          │
├─────────────────────────────────────────────────────────┤
│ 1️⃣  设置面板集成                                       │
│     └─ 性能 Tab 中添加缩略图配置                       │
│                                                         │
│ 2️⃣  缩略图管理面板                                     │
│     ├─ 索引按钮（一键索引未处理文件）                 │
│     ├─ 进度条（实时显示进度）                         │
│     ├─ 统计信息（已处理/总数/缓存大小）               │
│     └─ 控制按钮（暂停/恢复/清空缓存）                 │
│                                                         │
│ 3️⃣  视频支持                                           │
│     └─ FFmpeg 生成视频缩略图                           │
│                                                         │
│ 4️⃣  统一缓存流程                                       │
│     └─ 图片、压缩包、视频使用同一套缓存系统           │
└─────────────────────────────────────────────────────────┘
```

---

## 🎯 功能详解

### 功能 1: 设置面板集成

**目标**: 将缩略图配置从硬编码移到设置界面

**配置项**:
- 本地文件并发数 (当前: 6)
- 压缩包并发数 (当前: 3)
- 视频处理并发数 (新增: 2)
- 缓存大小 (新增: 500MB)
- 缩略图尺寸 (新增: 256px)
- 启用视频缩略图 (新增: 开启)

**UI 位置**: 设置 → 性能 Tab → 缩略图设置

**用户收益**:
- 无需修改代码即可调整性能
- 配置自动保存
- 实时生效

---

### 功能 2: 缩略图管理面板

**目标**: 在左侧边栏添加缩略图管理面板

**核心功能**:

#### 📊 统计信息
```
已处理: 150/500 (30%)
缓存大小: 245MB
处理速度: 12 缩略图/秒
当前任务: processing_file.jpg
```

#### ⏳ 进度条
```
[████████░░░░░░░░░░░░] 60%
```

#### 🎛️ 控制按钮
- **开始索引**: 扫描目录，索引未处理的缩略图
- **暂停**: 暂停当前索引过程
- **恢复**: 恢复已暂停的索引
- **清空缓存**: 清理所有缓存的缩略图

**索引流程**:
```
用户点击"开始索引"
    ↓
选择要索引的目录
    ↓
扫描所有文件
    ↓
检查缓存（跳过已处理）
    ↓
识别文件类型
    ↓
入队处理
    ↓
实时显示进度
    ↓
完成后显示统计
```

**用户收益**:
- 一键索引整个目录
- 实时了解进度
- 可随时暂停/恢复
- 清晰的统计信息

---

### 功能 3: 视频支持

**目标**: 使用 FFmpeg 为视频文件生成缩略图

**支持格式**:
- MP4, MKV, AVI, MOV, FLV, WebM, WMV

**处理流程**:
```
视频文件 (video.mp4)
    ↓
检测 FFmpeg 可用性
    ↓
FFmpeg 提取帧 (默认 10 秒处)
    ↓
生成缩略图 (256x256)
    ↓
缓存到磁盘
    ↓
记录到数据库
    ↓
显示在文件列表
```

**配置选项**:
- 启用/禁用视频处理
- 截图时间点 (秒)
- 视频处理并发数

**用户收益**:
- 视频文件有缩略图
- 快速识别视频内容
- 与其他文件类型统一处理

---

### 功能 4: 统一缓存流程

**目标**: 所有文件类型使用同一套缓存系统

**缓存键格式**:
```
type::path::identifier

示例:
- image::/home/user/pic.jpg
- archive::/home/user/book.zip
- video::/home/user/movie.mp4
- video::/home/user/movie.mp4::10    # 10秒处
```

**缓存流程**:
```
文件类型识别
    ↓
生成缓存键
    ↓
检查缓存存在
    ├─ 存在 → 返回缓存
    └─ 不存在 → 生成缩略图
        ↓
    保存到磁盘
        ↓
    记录到数据库
        ↓
    返回缓存路径
```

**缓存存储**:
- 位置: `~/.neoview/cache/thumbnails/`
- 格式: WebP (高效压缩)
- 大小限制: 可配置 (默认 500MB)

**用户收益**:
- 统一的缓存管理
- 自动失效机制
- 增量更新支持
- 更快的加载速度

---

## 📊 实现规模

### 代码变更量

| 模块 | 文件数 | 行数 | 复杂度 |
|------|-------|------|--------|
| 设置面板 | 3 | ~200 | 低 |
| 管理面板 | 2 | ~400 | 中 |
| 视频支持 | 3 | ~500 | 高 |
| 统一缓存 | 2 | ~300 | 中 |
| **总计** | **10** | **~1400** | **中** |

### 新增文件

```
src/lib/components/panels/ThumbnailPanel.svelte
src/lib/stores/thumbnail.svelte.ts
src-tauri/src/core/video_thumbnail.rs
src-tauri/src/commands/video_commands.rs
```

### 修改文件

```
src/lib/types/settings.ts
src/lib/components/panels/SettingsPanel.svelte
src/lib/settings/settingsManager.ts
src/lib/components/panels/FileBrowser.svelte
src/lib/utils/thumbnailManager.ts
src-tauri/src/core/thumbnail.rs
```

---

## 🔄 实现顺序

### 推荐分阶段实现

**第 1 阶段 (1-2 天)**: 设置面板集成 🔴 高优先级
- 扩展设置类型定义
- 添加 UI 组件
- 实现配置持久化
- 动态应用配置

**第 2 阶段 (2-3 天)**: 缩略图管理面板 🔴 高优先级
- 创建管理面板组件
- 实现索引逻辑
- 实现进度跟踪
- 实现任务控制

**第 3 阶段 (3-4 天)**: 视频支持 🟡 中优先级
- 集成 FFmpeg
- 实现视频帧提取
- 创建 Tauri 命令
- 前端集成

**第 4 阶段 (2-3 天)**: 统一缓存系统 🟡 中优先级
- 统一缓存键格式
- 实现通用查询接口
- 实现失效机制
- 修改各处理器

**第 5 阶段 (2-3 天)**: 测试和优化 🟡 中优先级
- 单元测试
- 集成测试
- 性能测试
- 文档编写

**总计**: 12-18 天

---

## 🏗️ 架构设计

### 前端架构

```
┌─────────────────────────────────────────┐
│         用户界面层                      │
├─────────────────────────────────────────┤
│ SettingsPanel  │  ThumbnailPanel        │
│ (设置)         │  (管理)                │
└────────┬───────────────┬────────────────┘
         │               │
         ↓               ↓
┌─────────────────────────────────────────┐
│         状态管理层                      │
├─────────────────────────────────────────┤
│ settingsManager  │  thumbnailStore      │
└────────┬───────────────┬────────────────┘
         │               │
         ↓               ↓
┌─────────────────────────────────────────┐
│         业务逻辑层                      │
├─────────────────────────────────────────┤
│ thumbnailManager (队列、并发、缓存)    │
└────────┬────────────────────────────────┘
         │
         ↓
┌─────────────────────────────────────────┐
│         Tauri IPC 通信                  │
└────────┬────────────────────────────────┘
         │
         ↓
┌─────────────────────────────────────────┐
│         后端处理层 (Rust)               │
├─────────────────────────────────────────┤
│ ThumbnailManager                        │
│ ├─ 图片处理 (image crate)              │
│ ├─ 压缩包处理 (zip crate)              │
│ └─ 视频处理 (FFmpeg)                   │
└────────┬────────────────────────────────┘
         │
         ↓
┌─────────────────────────────────────────┐
│         数据存储层                      │
├─────────────────────────────────────────┤
│ SQLite (元数据)  │  文件系统 (缓存)    │
└─────────────────────────────────────────┘
```

### 后端架构

```
ThumbnailManager
├── 类型识别
│   ├── 图片 → ImageProcessor
│   ├── 压缩包 → ArchiveProcessor
│   └── 视频 → VideoProcessor
│
├── 处理流程
│   ├── 检查缓存
│   ├── 生成缩略图
│   ├── 保存到磁盘
│   └── 记录到数据库
│
└── 缓存管理
    ├── 内存缓存 (LRU)
    ├── 磁盘缓存 (WebP)
    └── 数据库索引 (SQLite)
```

---

## 📈 性能指标

### 目标性能

| 指标 | 目标 | 当前 |
|------|------|------|
| 首屏加载 | <500ms | ~300ms ✅ |
| 完整加载 | <3s | ~1.8s ✅ |
| 索引速度 | >10/s | 待测试 |
| 内存占用 | <200MB | ~120MB ✅ |
| 缓存命中 | >80% | 待测试 |

### 并发配置

| 类型 | 并发数 | 原因 |
|------|--------|------|
| 本地文件 | 6-8 | CPU 密集 |
| 压缩包 | 3-4 | I/O 密集 |
| 视频 | 2-3 | FFmpeg 资源密集 |

---

## ⚠️ 风险评估

| 风险 | 概率 | 影响 | 缓解方案 |
|------|------|------|---------|
| FFmpeg 依赖 | 高 | 中 | 自动检测，提供下载 |
| 性能下降 | 中 | 中 | 充分的并发控制 |
| 缓存不一致 | 低 | 高 | 完善的失效机制 |
| 内存溢出 | 低 | 中 | 限制缓存大小 |

---

## 📚 相关文档

已生成的详细规划文档：

1. **THUMBNAIL_ENHANCEMENT_PLAN.md** - 完整的功能规划
2. **IMPLEMENTATION_ROADMAP.md** - 详细的实现路线图
3. **THUMBNAIL_FEATURES_QUICK_START.md** - 快速参考指南

---

## ✅ 下一步行动

### 立即可做
1. ✅ 确认需求完整性
2. ✅ 确认优先级排序
3. ✅ 确认时间表
4. ✅ 分配资源

### 准备工作
1. 📋 创建任务列表
2. 📋 准备开发环境
3. 📋 准备测试用例
4. 📋 准备文档模板

### 开始实现
1. 🚀 从阶段 1 开始 (设置面板)
2. 🚀 按阶段递进
3. 🚀 定期测试和反馈
4. 🚀 持续优化

---

## 📞 沟通要点

### 需要确认的事项
- [ ] 4 个功能是否完整
- [ ] 优先级排序是否合理
- [ ] 12-18 天的时间估计是否可接受
- [ ] 是否需要调整功能范围
- [ ] 是否需要额外的功能

### 需要提供的资源
- [ ] 开发人员 (1-2 人)
- [ ] 测试人员 (1 人)
- [ ] 文档编写 (0.5 人)
- [ ] FFmpeg 环境配置

---

**文档版本**: 1.0  
**创建时间**: 2024-11-15  
**状态**: 规划完成，等待确认  
**下一步**: 确认需求并开始实现
