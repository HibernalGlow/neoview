# StackViewer 层叠式架构设计

## 模块化文件结构

```
src/lib/viewer/
├── index.ts                    # 主导出
├── StackViewer.svelte          # 主容器组件
│
├── layers/                     # 层组件
│   ├── index.ts                # 层导出
│   ├── BackgroundLayer.svelte  # Layer 0: 背景层
│   ├── PreloadLayer.svelte     # Layer 1: 扩展预加载层
│   ├── PrevFrameLayer.svelte   # Layer 2: 前帧层
│   ├── NextFrameLayer.svelte   # Layer 3: 后帧层
│   ├── CurrentFrameLayer.svelte # Layer 4: 当前帧层
│   ├── UpscaleLayer.svelte     # Layer 5: 超分层
│   ├── ComparisonLayer.svelte  # Layer 6: 对比层
│   ├── InfoLayer.svelte        # Layer 7: 信息层
│   ├── ControlLayer.svelte     # Layer 8: 控制层
│   └── GestureLayer.svelte     # Layer 9: 手势层
│
├── frames/                     # 帧布局组件
│   ├── index.ts                # 帧导出
│   ├── SingleFrame.svelte      # 单页布局
│   ├── DoubleFrame.svelte      # 双页布局
│   ├── PanoramaFrame.svelte    # 全景布局
│   └── VideoFrame.svelte       # 视频布局
│
├── renderers/                  # 渲染器组件
│   ├── index.ts                # 渲染器导出
│   ├── ImageRenderer.svelte    # 图片渲染（支持分割、旋转）
│   ├── VideoRenderer.svelte    # 视频渲染
│   └── SplitRenderer.svelte    # 分割页面渲染
│
├── stores/                     # 状态管理
│   ├── index.ts                # Store 导出
│   ├── viewerState.ts          # 查看器状态
│   ├── frameState.ts           # 帧状态
│   └── gestureState.ts         # 手势状态
│
├── utils/                      # 工具函数
│   ├── index.ts                # 工具导出
│   ├── transform.ts            # 变换计算
│   ├── layout.ts               # 布局计算
│   └── preload.ts              # 预加载逻辑
│
└── types/                      # 类型定义
    ├── index.ts                # 类型导出
    ├── layer.ts                # 层类型
    ├── frame.ts                # 帧类型
    └── gesture.ts              # 手势类型
```

---

## 参考 NeeView 功能清单

### 核心显示功能

| 功能 | NeeView | 当前状态 | 层级 | 说明 |
|------|---------|----------|------|------|
| 单页显示 | ✅ | ✅ | 当前帧层 | 一次显示一页 |
| 双页显示 | ✅ | ✅ | 当前帧层 | 一次显示两页 |
| 全景模式 | ✅ | ✅ | 当前帧层 | 连续滚动多页 |
| 横向分割 | ✅ | ✅ | 当前帧层 | 横向图分成两个虚拟页 |
| 自动旋转 | ✅ | ✅ | 当前帧层 | 横向图旋转90度显示 |
| 缩放 | ✅ | ✅ | 变换层 | 放大/缩小 |
| 旋转 | ✅ | ✅ | 变换层 | 90度旋转 |
| 平移 | ✅ | ✅ | 变换层 | 拖拽移动 |

### 页面分割详解

```
┌─────────────────────────────────────────────────────────────┐
│                    横向分割 (Landscape Split)                │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  原始横向图片:                                               │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                                                         │ │
│  │                    Physical Page 0                      │ │
│  │                    (width > height)                     │ │
│  │                                                         │ │
│  └─────────────────────────────────────────────────────────┘ │
│                           ↓                                  │
│                      分割后:                                 │
│  ┌───────────────────────┐  ┌───────────────────────────┐   │
│  │                       │  │                           │   │
│  │   Virtual Page 0      │  │   Virtual Page 1          │   │
│  │   (左半)              │  │   (右半)                  │   │
│  │   clip: 0 50% 0 0     │  │   clip: 0 0 0 50%         │   │
│  │                       │  │                           │   │
│  └───────────────────────┘  └───────────────────────────┘   │
│                                                              │
│  阅读顺序:                                                   │
│  - LTR: 先显示左半，再显示右半                               │
│  - RTL: 先显示右半，再显示左半                               │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 自动旋转详解

```
┌─────────────────────────────────────────────────────────────┐
│                    自动旋转 (Auto Rotate)                    │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  原始横向图片:                                               │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                                                         │ │
│  │                    Physical Page 0                      │ │
│  │                    (width > height)                     │ │
│  │                                                         │ │
│  └─────────────────────────────────────────────────────────┘ │
│                           ↓                                  │
│                      旋转后:                                 │
│                    ┌───────────┐                            │
│                    │           │                            │
│                    │           │                            │
│                    │  Virtual  │                            │
│                    │  Page 0   │                            │
│                    │           │                            │
│                    │  rotate:  │                            │
│                    │  90deg    │                            │
│                    │           │                            │
│                    │           │                            │
│                    └───────────┘                            │
│                                                              │
│  适用场景:                                                   │
│  - 手机竖屏阅读横向漫画                                      │
│  - 优先级低于分割（分割开启时不旋转）                         │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 双页模式详解

```
┌─────────────────────────────────────────────────────────────┐
│                    双页模式 (Double Page)                    │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  LTR 模式 (左到右):                                          │
│  ┌───────────────────────┬───────────────────────┐          │
│  │                       │                       │          │
│  │   Page N              │   Page N+1            │          │
│  │   (左侧)              │   (右侧)              │          │
│  │                       │                       │          │
│  └───────────────────────┴───────────────────────┘          │
│                                                              │
│  RTL 模式 (右到左):                                          │
│  ┌───────────────────────┬───────────────────────┐          │
│  │                       │                       │          │
│  │   Page N+1            │   Page N              │          │
│  │   (左侧)              │   (右侧)              │          │
│  │                       │                       │          │
│  └───────────────────────┴───────────────────────┘          │
│                                                              │
│  横向图处理:                                                 │
│  - treatHorizontalAsDoublePage = true 时                     │
│  - 横向图独占整个双页区域                                    │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                                                         │ │
│  │                    Landscape Page                       │ │
│  │                    (独占双页)                           │ │
│  │                                                         │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 预加载功能

| 功能 | NeeView | 当前状态 | 层级 |
|------|---------|----------|------|
| 前页预加载 | ✅ | ✅ | 前帧层 |
| 后页预加载 | ✅ | ✅ | 后帧层 |
| 多页预加载 | ✅ | 🔄 | 扩展预加载层 |

### 超分功能

| 功能 | NeeView | 当前状态 | 层级 |
|------|---------|----------|------|
| 超分显示 | N/A | ✅ | 超分层 |
| 超分进度 | N/A | 🔄 | 信息层 |
| 超分对比 | N/A | 🔄 | 对比层 |

### 交互功能

| 功能 | NeeView | 当前状态 | 层级 |
|------|---------|----------|------|
| 点击翻页 | ✅ | ✅ | 手势层 |
| 拖拽平移 | ✅ | ✅ | 手势层 |
| 滚轮缩放 | ✅ | ✅ | 手势层 |
| 双击重置 | ✅ | 🔄 | 手势层 |
| 捏合缩放 | ✅ | 🔄 | 手势层 |

### UI 覆盖层

| 功能 | NeeView | 当前状态 | 层级 |
|------|---------|----------|------|
| 页面信息 | ✅ | ✅ | 信息层 |
| 进度条 | ✅ | ✅ | 信息层 |
| 加载指示器 | ✅ | 🔄 | 信息层 |
| 导航按钮 | ✅ | 🔄 | 控制层 |

---

## 层叠架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                    StackViewer Container                     │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ Layer 9: 手势层 (GestureLayer)                         │ │  z-index: 90
│  │ - 透明，捕获所有指针事件                                │ │
│  │ - 处理点击、拖拽、缩放手势                              │ │
│  │ - 不与其他 UI 冲突                                     │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ Layer 8: 控制层 (ControlLayer)                         │ │  z-index: 80
│  │ - 导航按钮（上一页/下一页）                             │ │
│  │ - 工具按钮（缩放、旋转等）                              │ │
│  │ - 悬浮时显示                                           │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ Layer 7: 信息层 (InfoLayer)                            │ │  z-index: 70
│  │ - 页面信息（当前页/总页数）                             │ │
│  │ - 进度条                                               │ │
│  │ - 加载指示器                                           │ │
│  │ - 超分进度                                             │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ Layer 6: 对比层 (ComparisonLayer)                      │ │  z-index: 60
│  │ - 超分前后对比                                         │ │
│  │ - 滑动对比 UI                                          │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ Layer 5: 超分层 (UpscaleLayer)                         │ │  z-index: 50
│  │ - 超分后的图片                                         │ │
│  │ - 覆盖在原图上                                         │ │
│  │ - 支持渐进显示                                         │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ Layer 4: 当前帧层 (CurrentFrameLayer)                  │ │  z-index: 40
│  │ - 当前显示的页面                                       │ │
│  │ - 支持单页/双页/全景布局                                │ │
│  │ - 应用缩放/旋转/平移变换                                │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ Layer 3: 后帧层 (NextFrameLayer)                       │ │  z-index: 30
│  │ - 下一帧的预加载                                       │ │
│  │ - 隐藏但已加载                                         │ │
│  │ - 翻页时快速切换                                       │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ Layer 2: 前帧层 (PrevFrameLayer)                       │ │  z-index: 20
│  │ - 上一帧的预加载                                       │ │
│  │ - 隐藏但已加载                                         │ │
│  │ - 翻页时快速切换                                       │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ Layer 1: 扩展预加载层 (ExtendedPreloadLayer)           │ │  z-index: 10
│  │ - 更多页面的预加载列表 快速替换当前层和前后帧                               │ │
│  │ - 用于快速跳转                                         │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ Layer 0: 背景层 (BackgroundLayer)                      │ │  z-index: 0
│  │ - 背景颜色                                             │ │
│  │ - 支持自动背景色                                       │ │
│  │ - 支持自定义背景                                       │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 扩展接口设计

### 1. 层注册接口

```typescript
interface LayerConfig {
  id: string;
  zIndex: number;
  component: SvelteComponent;
  props?: Record<string, unknown>;
  visible?: boolean;
  pointerEvents?: 'auto' | 'none';
}

interface StackViewerAPI {
  // 注册自定义层
  registerLayer(config: LayerConfig): void;
  
  // 移除层
  unregisterLayer(id: string): void;
  
  // 获取层
  getLayer(id: string): LayerConfig | null;
  
  // 更新层属性
  updateLayer(id: string, props: Partial<LayerConfig>): void;
  
  // 层可见性控制
  showLayer(id: string): void;
  hideLayer(id: string): void;
  toggleLayer(id: string): void;
}
```

### 2. 帧数据接口

```typescript
interface FrameImage {
  url: string;
  physicalIndex: number;
  virtualIndex: number;
  splitHalf?: 'left' | 'right' | null;
  rotation?: 0 | 90 | 180 | 270;
  width?: number;
  height?: number;
}

interface Frame {
  id: string;
  images: FrameImage[];
  layout: 'single' | 'double' | 'panorama';
  direction: 'ltr' | 'rtl';
}

interface FrameProvider {
  getCurrentFrame(): Frame;
  getPrevFrame(): Frame;
  getNextFrame(): Frame;
  getUpscaledFrame(): Frame | null;
}
```

### 3. 手势接口

```typescript
interface GestureConfig {
  enableTap: boolean;
  enableDoubleTap: boolean;
  enablePan: boolean;
  enablePinch: boolean;
  enableWheel: boolean;
  
  tapZones: {
    left: number;   // 0-1, 左侧区域占比
    right: number;  // 0-1, 右侧区域占比
  };
}

interface GestureEvents {
  onTap?: (zone: 'left' | 'center' | 'right', point: Point) => void;
  onDoubleTap?: (point: Point) => void;
  onPan?: (delta: Point) => void;
  onPinch?: (scale: number, center: Point) => void;
  onWheel?: (delta: number, point: Point) => void;
}
```

---

## 边栏层叠设计

边栏也可以采用层叠式设计，好处：
1. 不需要持久化记忆边栏状态
2. 点击按钮直接切换层的可见性
3. 动画过渡更平滑

```
┌─────────────────────────────────────────────────────────────┐
│                      Main Container                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────┐  ┌────────────────────────────────────────┐   │
│  │ Sidebar  │  │                                        │   │
│  │ Stack    │  │           StackViewer                  │   │
│  │          │  │                                        │   │
│  │ ┌──────┐ │  │                                        │   │
│  │ │Panel │ │  │                                        │   │
│  │ │  4   │ │  │                                        │   │
│  │ └──────┘ │  │                                        │   │
│  │ ┌──────┐ │  │                                        │   │
│  │ │Panel │ │  │                                        │   │
│  │ │  3   │ │  │                                        │   │
│  │ └──────┘ │  │                                        │   │
│  │ ┌──────┐ │  │                                        │   │
│  │ │Panel │ │  │                                        │   │
│  │ │  2   │ │  │                                        │   │
│  │ └──────┘ │  │                                        │   │
│  │ ┌──────┐ │  │                                        │   │
│  │ │Panel │ │  │                                        │   │
│  │ │  1   │ │  │                                        │   │
│  │ └──────┘ │  │                                        │   │
│  └──────────┘  └────────────────────────────────────────┘   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

边栏面板：
- Panel 1: 文件列表
- Panel 2: 页面列表
- Panel 3: 书签
- Panel 4: 设置

点击按钮切换对应面板的可见性，其他面板自动隐藏。

---

## 实现路线图

### Phase 1: 基础层叠 (当前)
- [x] 背景层
- [x] 前帧层
- [x] 后帧层
- [x] 当前帧层
- [x] 超分层
- [ ] 手势层

### Phase 2: 信息层
- [ ] 页面信息
- [ ] 进度条
- [ ] 加载指示器

### Phase 3: 控制层
- [ ] 导航按钮
- [ ] 工具按钮

### Phase 4: 高级功能
- [ ] 对比层
- [ ] 扩展预加载层
- [ ] 自定义层注册

### Phase 5: 边栏层叠
- [ ] 边栏容器
- [ ] 面板切换
- [ ] 动画过渡

---

## 视频处理

### 视频与手势层的冲突解决

视频播放器有自己的控件（播放/暂停、进度条、音量等），需要特殊处理：

```
┌─────────────────────────────────────────────────────────────┐
│                    视频模式下的层叠                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ Layer 9: 手势层 (条件性)                               │ │  z-index: 90
│  │ - 视频模式下：只处理边缘区域的点击翻页                  │ │
│  │ - 中心区域：pointer-events: none，让视频控件接收事件    │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ Layer 4: 当前帧层 (视频)                               │ │  z-index: 40
│  │ - <video> 元素                                         │ │
│  │ - 原生控件 (controls)                                  │ │
│  │ - 或自定义控件                                         │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**解决方案：**

1. **区域分离**
   ```css
   .gesture-layer {
     /* 视频模式下，只在边缘区域捕获事件 */
     clip-path: polygon(
       0 0, 20% 0, 20% 100%, 0 100%,  /* 左边缘 */
       80% 0, 100% 0, 100% 100%, 80% 100%  /* 右边缘 */
     );
   }
   ```

2. **事件穿透**
   ```typescript
   // 检测点击位置，如果在视频控件区域则不处理
   function handleTap(point: Point) {
     if (isVideoMode && isInVideoControlArea(point)) {
       return; // 让事件穿透到视频控件
     }
     // 处理翻页
   }
   ```

3. **模式切换**
   ```typescript
   // 视频模式下禁用部分手势
   const gestureConfig = $derived({
     enablePan: !isVideoMode,
     enablePinch: !isVideoMode,
     enableTap: true, // 保留边缘点击翻页
   });
   ```

---

## 边栏层叠式分析

### 当前边栏实现
- 使用 Svelte 条件渲染 (`{#if}`)
- 状态存储在 store 中
- 切换时需要重新渲染

### 层叠式边栏

**优点：**
- ✅ 切换更快（只改变 opacity/visibility）
- ✅ 保持 DOM 状态（滚动位置、输入内容等）
- ✅ 动画过渡更平滑
- ✅ 不需要持久化记忆（面板已在 DOM 中）

**缺点：**
- ❌ 内存占用更高（所有面板都在 DOM 中）
- ❌ 初始加载更慢
- ❌ 实现复杂度略高

### 建议

**对于边栏：不建议使用层叠式**

原因：
1. **边栏面板较重** - 文件列表、页面列表可能有很多项
2. **切换不频繁** - 用户通常只用一个面板
3. **当前实现够用** - Svelte 的条件渲染已经很快

**更好的方案：**
- 使用 `{#if}` 条件渲染
- 添加 CSS 过渡动画
- 使用 `<svelte:component>` 动态组件

```svelte
<div class="sidebar" class:visible={sidebarVisible}>
  {#if activePanel === 'files'}
    <FileListPanel />
  {:else if activePanel === 'pages'}
    <PageListPanel />
  {:else if activePanel === 'bookmarks'}
    <BookmarksPanel />
  {/if}
</div>

<style>
  .sidebar {
    transform: translateX(-100%);
    transition: transform 0.2s ease;
  }
  .sidebar.visible {
    transform: translateX(0);
  }
</style>
```

### 层叠式适合的场景

| 场景 | 是否适合层叠式 | 原因 |
|------|---------------|------|
| 图片查看器 | ✅ 非常适合 | 频繁切换，需要预加载 |
| 超分对比 | ✅ 适合 | 需要快速切换显示 |
| 边栏面板 | ❌ 不适合 | 切换不频繁，内容较重 |
| 模态框 | ✅ 适合 | 需要快速显示/隐藏 |
| Toast 通知 | ✅ 适合 | 频繁显示/隐藏 |

---

## 简化的分割方案（新设计）

### 核心思路

**不用虚拟页面列表，而是用"双页模式"来处理分割**

```
┌─────────────────────────────────────────────────────────────┐
│                    简化分割方案                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  开启分割前（单页模式）:                                     │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                                                         │ │
│  │                    横向图完整显示                        │ │
│  │                                                         │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                              │
│  开启分割后（自动切换到双页模式）:                           │
│  ┌───────────────────────┬───────────────────────┐          │
│  │                       │                       │          │
│  │   左半（当前显示）     │   右半（隐藏）        │          │
│  │                       │                       │          │
│  └───────────────────────┴───────────────────────┘          │
│                                                              │
│  翻页后:                                                     │
│  ┌───────────────────────┬───────────────────────┐          │
│  │                       │                       │          │
│  │   左半（隐藏）        │   右半（当前显示）     │          │
│  │                       │                       │          │
│  └───────────────────────┴───────────────────────┘          │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 优点

1. **简单** - 不需要虚拟页面列表
2. **兼容** - 底部栏、页面列表等不需要修改
3. **直观** - 用户看到的就是"双页"
4. **无闪屏** - 同一张图的两半已经加载

### 实现方式

```typescript
// 当前帧层内部状态
let splitState = $state<'left' | 'right' | null>(null);

// 开启分割且当前图是横向时
if (divideLandscape && isLandscape) {
  splitState = splitState === 'left' ? 'right' : 'left';
}

// 翻页时
function handleNextPage() {
  if (splitState === 'left') {
    // 显示右半
    splitState = 'right';
  } else {
    // 翻到下一张图
    splitState = isNextLandscape ? 'left' : null;
    navigateToNextPage();
  }
}
```

---

## 超分预载层设计

### 层结构

```
┌─────────────────────────────────────────────────────────────┐
│                    超分预载层                                │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  当前页 + 前后 N 页：实体图片（已加载到内存）                │
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐                   │
│  │ -2  │ │ -1  │ │  0  │ │ +1  │ │ +2  │                   │
│  │实体 │ │实体 │ │实体 │ │实体 │ │实体 │                   │
│  └─────┘ └─────┘ └─────┘ └─────┘ └─────┘                   │
│                                                              │
│  更远的页：缓存链接（只保存 URL，需要时再加载）              │
│  ┌─────┐ ┌─────┐ ... ┌─────┐ ┌─────┐                       │
│  │ -5  │ │ -4  │     │ +4  │ │ +5  │                       │
│  │链接 │ │链接 │     │链接 │ │链接 │                       │
│  └─────┘ └─────┘     └─────┘ └─────┘                       │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 超分缓存策略

```typescript
interface UpscaleCache {
  // 实体图片（Blob URL）
  loaded: Map<number, string>;
  // 缓存链接（超分后的文件路径）
  cached: Map<number, string>;
}

// 预载范围
const PRELOAD_RANGE = 2;  // 当前页前后各 2 页
const CACHE_RANGE = 10;   // 缓存链接范围

function updateUpscaleCache(currentIndex: number) {
  // 1. 加载当前页前后的超分图
  for (let i = -PRELOAD_RANGE; i <= PRELOAD_RANGE; i++) {
    const index = currentIndex + i;
    if (!cache.loaded.has(index) && cache.cached.has(index)) {
      loadUpscaledImage(index, cache.cached.get(index)!);
    }
  }
  
  // 2. 清理超出范围的实体图片
  cache.loaded.forEach((_, index) => {
    if (Math.abs(index - currentIndex) > PRELOAD_RANGE) {
      revokeObjectURL(cache.loaded.get(index)!);
      cache.loaded.delete(index);
    }
  });
}
```

---

## LayerSet 设计（多 Book 支持）

### 核心思路

**不同 book 使用不同的 layer 集合，方便快速切换和缓存**

```
┌─────────────────────────────────────────────────────────────┐
│                    LayerSet 架构                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  Book A (当前)                    Book B (后台)              │
│  ┌─────────────────────┐         ┌─────────────────────┐    │
│  │ LayerSet A          │         │ LayerSet B          │    │
│  │ ┌─────────────────┐ │         │ ┌─────────────────┐ │    │
│  │ │ CurrentFrame    │ │         │ │ CurrentFrame    │ │    │
│  │ │ (page 5)        │ │         │ │ (page 12)       │ │    │
│  │ └─────────────────┘ │         │ └─────────────────┘ │    │
│  │ ┌─────────────────┐ │         │ ┌─────────────────┐ │    │
│  │ │ PrevFrame       │ │         │ │ PrevFrame       │ │    │
│  │ │ (page 4)        │ │         │ │ (page 11)       │ │    │
│  │ └─────────────────┘ │         │ └─────────────────┘ │    │
│  │ ┌─────────────────┐ │         │ ┌─────────────────┐ │    │
│  │ │ NextFrame       │ │         │ │ NextFrame       │ │    │
│  │ │ (page 6)        │ │         │ │ (page 13)       │ │    │
│  │ └─────────────────┘ │         │ └─────────────────┘ │    │
│  │ ┌─────────────────┐ │         │ ┌─────────────────┐ │    │
│  │ │ UpscaleCache    │ │         │ │ UpscaleCache    │ │    │
│  │ │ (pages 3-7)     │ │         │ │ (pages 10-14)   │ │    │
│  │ └─────────────────┘ │         │ └─────────────────┘ │    │
│  └─────────────────────┘         └─────────────────────┘    │
│                                                              │
│  切换 Book 时：                                              │
│  1. 保存当前 LayerSet 状态                                   │
│  2. 切换到目标 LayerSet                                      │
│  3. 恢复目标 LayerSet 状态（页面位置、缩放等）               │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 接口设计

```typescript
interface LayerSet {
  id: string;              // book id
  bookPath: string;        // book 路径
  currentIndex: number;    // 当前页索引
  transform: Transform;    // 变换状态（缩放、旋转、平移）
  
  // 帧缓存
  frames: {
    current: Frame;
    prev: Frame;
    next: Frame;
  };
  
  // 超分缓存
  upscaleCache: Map<number, string>;
  
  // 预加载队列
  preloadQueue: number[];
}

interface LayerSetManager {
  // 当前活动的 LayerSet
  active: LayerSet | null;
  
  // 所有 LayerSet（LRU 缓存）
  sets: Map<string, LayerSet>;
  
  // 最大缓存数量
  maxSets: number;
  
  // 切换 LayerSet
  switchTo(bookId: string): void;
  
  // 创建新 LayerSet
  create(bookPath: string): LayerSet;
  
  // 销毁 LayerSet
  destroy(bookId: string): void;
  
  // 清理最旧的 LayerSet
  evictOldest(): void;
}
```

### 优点

1. **快速切换** - 切换 book 时只需切换 LayerSet 引用
2. **状态保持** - 每个 book 的阅读位置、缩放等独立保存
3. **缓存复用** - 预加载的图片和超分结果可以复用
4. **内存可控** - 通过 LRU 策略控制缓存数量

---

## HoverLayer 悬停层

### 功能

1. **悬停滚动** - 鼠标靠近边缘时自动滚动图片
2. **悬停平移** - 鼠标位置控制图片平移方向

### 配置

```typescript
interface HoverConfig {
  // 悬停滚动
  enableHoverScroll: boolean;
  hoverScrollSpeed: number;      // 滚动速度
  hoverScrollZone: number;       // 边缘区域占比 (0-0.5)
  
  // 悬停平移
  enableHoverPan: boolean;
  hoverPanSensitivity: number;   // 平移灵敏度
}
```

### 层级

- z-index: 85（在手势层之下，信息层之上）
- 与手势层互斥：悬停平移时禁用拖拽平移

---

## Flow 模式调试层

### 功能

在 Flow 模式下显示每个层的状态，用于调试和可视化：

```
┌─────────────────────────────────────────────────────────────┐
│                    Flow 模式调试视图                         │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ 层状态面板                                            │   │
│  │ ┌────────────────────────────────────────────────┐   │   │
│  │ │ Layer 9: Gesture    [✓] pointer-events: auto   │   │   │
│  │ │ Layer 8: Hover      [✗] disabled               │   │   │
│  │ │ Layer 7: Info       [✓] visible                │   │   │
│  │ │ Layer 5: Upscale    [✗] no upscaled image      │   │   │
│  │ │ Layer 4: Current    [✓] page 5, loaded         │   │   │
│  │ │ Layer 3: Next       [✓] page 6, preloaded      │   │   │
│  │ │ Layer 2: Prev       [✓] page 4, preloaded      │   │   │
│  │ │ Layer 0: Background [✓] #1a1a1a                │   │   │
│  │ └────────────────────────────────────────────────┘   │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ 预加载状态                                            │   │
│  │ [■■■■■□□□□□] 5/10 pages preloaded                    │   │
│  │ [■■□□□□□□□□] 2/10 pages upscaled                     │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 实现

- 只在 Flow 模式下渲染调试面板
- 使用 `$inspect` 或自定义 store 收集层状态
- 不影响 Classic 模式性能

```svelte
{#if $isFlowMode && $showDebugPanel}
  <DebugLayer 
    layers={$layerStates}
    preloadStatus={$preloadStatus}
    upscaleStatus={$upscaleStatus}
  />
{/if}
```

---

## 迁移策略

采用"忒休斯之船"策略，逐步替换：

1. **创建 StackViewer 组件** ✅
2. **添加开关切换** - 在设置中添加"使用新 Viewer"选项
3. **功能对齐** - 确保 StackViewer 支持所有现有功能
4. **逐步迁移** - 一个功能一个功能地迁移
5. **移除旧代码** - 确认稳定后移除旧 Viewer

每个阶段都保持应用可用，用户可以随时切换回旧版本。
